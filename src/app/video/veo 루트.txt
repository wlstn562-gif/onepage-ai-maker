// src/app/api/veo/route.ts
import { NextResponse } from "next/server";
import { GoogleAuth } from "google-auth-library";

export const runtime = "nodejs";

const sleep = (ms: number) => new Promise((r) => setTimeout(r, ms));

function getTokenValue(access: any): string | null {
    if (!access) return null;
    if (typeof access === "string") return access;
    if (typeof access?.token === "string") return access.token;
    return null;
}

export async function POST(req: Request) {
    try {
        const body = await req.json().catch(() => ({}));
        const prompt = String(body?.prompt || body?.scenes?.[0]?.promptEn || "").trim();
        const aspectRatio = body?.aspectRatio === "9:16" ? "9:16" : "16:9";

        if (!prompt) {
            return NextResponse.json({ error: "prompt가 비었어요" }, { status: 400 });
        }

        const projectId = process.env.GOOGLE_PROJECT_ID || "gen-lang-client-0372916912";
        const location = "us-central1";
        const modelId = "veo-3.0-fast-generate-001";
        const apiVersion = "v1beta1";
        const apiHost = `https://${location}-aiplatform.googleapis.com`;

        // ✅ 인증
        const auth = new GoogleAuth({
            scopes: ["https://www.googleapis.com/auth/cloud-platform"],
            projectId,
        });
        const client = await auth.getClient();
        const access = await client.getAccessToken();
        const token = getTokenValue(access);

        if (!token) {
            return NextResponse.json({ error: "Google access token 생성 실패" }, { status: 500 });
        }

        // ✅ 1) Start: predictLongRunning
        const startUrl =
            `${apiHost}/${apiVersion}/projects/${projectId}/locations/${location}` +
            `/publishers/google/models/${modelId}:predictLongRunning`;

        const startRes = await fetch(startUrl, {
            method: "POST",
            headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                instances: [{ prompt }],
                parameters: {
                    aspectRatio,
                    sampleCount: 1,
                },
            }),
        });

        const startText = await startRes.text();
        if (!startRes.ok) {
            // ✅ 프론트가 HTML로 오해 안하게 JSON으로 반환
            return NextResponse.json({ error: `Veo 시작 실패: ${startText}` }, { status: startRes.status });
        }

        const startData: any = JSON.parse(startText);
        const opName: string = startData?.name; // projects/.../operations/...
        if (!opName) {
            return NextResponse.json({ error: `operation name(name) 없음: ${startText}` }, { status: 500 });
        }

        // ✅ 2) Poll: fetchPredictOperation (POST로 폴링)
        const fetchUrl =
            `${apiHost}/${apiVersion}/projects/${projectId}/locations/${location}` +
            `/publishers/google/models/${modelId}:fetchPredictOperation`;

        // 약간 대기
        await sleep(1500);

        for (let i = 0; i < 90; i++) {
            const pollRes = await fetch(fetchUrl, {
                method: "POST",
                headers: {
                    Authorization: `Bearer ${token}`,
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ operationName: opName }),
            });

            const pollText = await pollRes.text();
            if (!pollRes.ok) {
                return NextResponse.json(
                    { error: `상태 확인 실패(${pollRes.status}): ${pollText}` },
                    { status: pollRes.status }
                );
            }

            const pollData: any = JSON.parse(pollText);

            if (pollData?.done) {
                if (pollData?.error?.message) {
                    return NextResponse.json({ error: pollData.error.message }, { status: 500 });
                }

                const videoBase64 =
                    pollData?.response?.videos?.[0]?.video?.bytesBase64Encoded ||
                    pollData?.response?.videos?.[0]?.bytesBase64Encoded ||
                    pollData?.response?.result?.videos?.[0]?.video?.bytesBase64Encoded ||
                    pollData?.response?.result?.videos?.[0]?.bytesBase64Encoded;

                const imageBase64 =
                    pollData?.response?.images?.[0]?.bytesBase64Encoded ||
                    pollData?.response?.result?.images?.[0]?.bytesBase64Encoded;

                if (videoBase64) {
                    return NextResponse.json({ videoDataUrl: `data:video/mp4;base64,${videoBase64}` });
                }
                if (imageBase64) {
                    return NextResponse.json({ imageDataUrl: `data:image/png;base64,${imageBase64}` });
                }

                return NextResponse.json(
                    { error: "완료됐는데 video/image 데이터가 없음", dump: pollData },
                    { status: 500 }
                );
            }

            await sleep(2000);
        }

        return NextResponse.json({ error: "타임아웃" }, { status: 504 });
    } catch (e: any) {
        return NextResponse.json({ error: e?.message || String(e) }, { status: 500 });
    }
}
