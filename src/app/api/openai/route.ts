import { NextResponse } from "next/server";
import OpenAI from "openai";
import fs from "fs/promises";
import path from "path";

export const runtime = "nodejs";

// Fallback Guide - IMPROVED VERSION
const condensedGuide = `
[Ïú†ÌäúÎ∏å Î°±Ìèº ÌïµÏã¨ ÏõêÏπô - ÌíàÏßà Ïö∞ÏÑ†]

‚òÖ‚òÖ‚òÖ Ï†àÎåÄ Í∏àÏßÄ ÏÇ¨Ìï≠ ‚òÖ‚òÖ‚òÖ
- "Ïó¨Í∏∞ÏÑú Ï∂©Í≤©Ï†ÅÏù∏ ÏÇ¨Ïã§ÏùÄ...", "ÌïòÏßÄÎßå Î∞òÏ†ÑÏù¥ ÏûàÏäµÎãàÎã§" Í∞ôÏùÄ Îπà ÍªçÎç∞Í∏∞ ÌëúÌòÑ Í∏àÏßÄ
- "ÎÜÄÎùºÏö¥ ÏÇ¨Ïã§", "ÎØøÍ∏∞ ÌûòÎì† Ïù¥ÏïºÍ∏∞" Îì± ÎÇ¥Ïö© ÏóÜÎäî ÎÇöÏãú Î¨∏Íµ¨ Í∏àÏßÄ
- Íµ¨Ï≤¥Ï†Å Ï†ïÎ≥¥ ÏóÜÏù¥ ÎπôÎπô ÎèåÎ¶¨Îäî ÎåÄÎ≥∏ Í∏àÏßÄ
- "Íµ¨ÎèÖÌï¥Ï£ºÏÑ∏Ïöî"Î•º 1Ìöå Ïù¥ÏÉÅ Ïñ∏Í∏â Í∏àÏßÄ (ÏòÅÏÉÅ ÎßàÏßÄÎßâÏóê Îî± 1Î≤àÎßå)

‚òÖ‚òÖ‚òÖ ÌïÑÏàò Ìè¨Ìï® ÏÇ¨Ìï≠ ‚òÖ‚òÖ‚òÖ
1. Íµ¨Ï≤¥Ï†Å Ìå©Ìä∏: Ïã§Ï†ú Ïà´Ïûê, ÎÇ†Ïßú, Ïù∏Î¨ºÎ™Ö, Í∏∞ÏóÖÎ™Ö, ÏÇ¨Í±¥Î™Ö ÌïÑÏàò
   - ÎÇòÏÅú Ïòà: "ÏµúÍ∑º Ìïú Ïó∞Íµ¨ÏóêÏÑú..."
   - Ï¢ãÏùÄ Ïòà: "2024ÎÖÑ MIT Ïó∞Íµ¨ÌåÄÏù¥ Î∞úÌëúÌïú ÎÖºÎ¨∏Ïóê Îî∞Î•¥Î©¥..."

2. Í≤ÄÏ¶ù Í∞ÄÎä•Ìïú Ï†ïÎ≥¥: ÏãúÏ≤≠ÏûêÍ∞Ä Í≤ÄÏÉâÌï¥ÏÑú ÌôïÏù∏Ìï† Ïàò ÏûàÎäî Ï†ïÎ≥¥
   - ÎÇòÏÅú Ïòà: "Ï†ÑÎ¨∏Í∞ÄÎì§ÏùÄ ÎßêÌï©ÎãàÎã§"
   - Ï¢ãÏùÄ Ïòà: "Í≤ΩÏ†úÌïôÏûê Ìè¥ ÌÅ¨Î£®Í∑∏Î®ºÏùÄ Îâ¥ÏöïÌÉÄÏûÑÏ¶à ÏπºÎüºÏóêÏÑú..."

3. ÎÖºÎ¶¨Ï†Å Ï†ÑÍ∞ú: Ï£ºÏû• ‚Üí Í∑ºÍ±∞ ‚Üí ÏÇ¨Î°Ä ÏàúÏÑúÎ°ú ÏÑ§Î™Ö
   - ÎßâÏó∞Ìïú Ï£ºÏû•Îßå ÎÇòÏó¥ÌïòÏßÄ ÎßêÍ≥†, Ïôú Í∑∏Îü∞ÏßÄ ÏÑ§Î™ÖÌï† Í≤É

4. ÎåÄÎπÑ Íµ¨Ï°∞: ÏûòÎêú ÏºÄÏù¥Ïä§ vs ÎßùÌïú ÏºÄÏù¥Ïä§ Íµ¨Ï≤¥Ï†Å ÏÇ¨Î°ÄÎ°ú ÎπÑÍµê

[ÎåÄÎ≥∏ Ïä§ÌÉÄÏùº]
- ÎßêÌà¨: ÏπúÍ∑ºÌïú Íµ¨Ïñ¥Ï≤¥ ("~Í±∞Îì†Ïöî", "~ÏûñÏïÑÏöî", "~Ïù∏Îç∞Ïöî")
- Î¨∏Ïû• Í∏∏Ïù¥: ÏßßÍ≥† Í∞ÑÍ≤∞ÌïòÍ≤å (Ìïú Î¨∏Ïû• 30Ïûê Ïù¥ÎÇ¥)
- Ï†ÑÎ¨∏Ïö©Ïñ¥: Ï¶âÏãú Ïâ¨Ïö¥ ÎßêÎ°ú ÌíÄÏñ¥ÏÑú ÏÑ§Î™Ö
`;

const CHARACTER_PROMPT = `High-quality animated character, expressive facial features, modern vector art style, wearing a professional suit or trendy outfit, detailed shading, unrelated to stickman.`;

export async function POST(req: Request) {
    try {
        const guideContent = condensedGuide;

        if (!process.env.OPENAI_API_KEY) {
            console.error("‚ùå OPENAI_API_KEY is missing in process.env");
            return NextResponse.json(
                { error: "OPENAI_API_KEYÍ∞Ä ÏóÜÏäµÎãàÎã§." },
                { status: 500 }
            );
        }

        const body = await req.json();
        const { mode = "generate", keyword, title, context, type = "basic" } = body;

        const client = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
        let systemPrompt = "";
        let userPrompt = "";
        let maxTokens = 4000; // Default limit

        if (mode === "script") {
            if (!body.topic) return NextResponse.json({ error: "topicÏù¥ ÌïÑÏöîÌï©ÎãàÎã§." }, { status: 400 });

            const duration = body.duration || 20; // Default 20
            let totalParts = 6;

            // Adjust parts based on duration
            if (duration === 5) totalParts = 3;
            else if (duration === 10) totalParts = 4;
            else if (duration === 15) totalParts = 5;
            else totalParts = 6;

            const part = body.part || 1; // 1 to totalParts
            const previousContext = body.previousContext || "ÏóÜÏùå (Ï≤´ ÏãúÏûë)";
            // üÜï ÏßÄÏãù Î≤†Ïù¥Ïä§ÏóêÏÑú Í∞ÄÏ†∏Ïò® Ìå©Ìä∏
            const knowledgeFacts = body.knowledgeFacts || "";

            // Limit output tokens - INCREASED for quality (was 1600)
            maxTokens = 2500;

            // Define guidelines for each part
            let partInstruction = "";
            let timeRange = "";

            if (duration === 5) {
                // 5 Minute Short-Form Structure (3 Parts)
                switch (part) {
                    case 1:
                        timeRange = "0:00~1:30 (Part 1/3)";
                        partInstruction = "ÏûëÏÑ± Íµ¨Í∞Ñ: [0:00~1:30] ÌõÑÌÇπ + Î¨∏Ï†úÏ†úÍ∏∞. Îπ†Î•¥Í≤å Î≥∏Î°†ÏúºÎ°ú ÏßÑÏûÖ.";
                        break;
                    case 2:
                        timeRange = "1:30~3:30 (Part 2/3)";
                        partInstruction = "ÏûëÏÑ± Íµ¨Í∞Ñ: [1:30~3:30] ÌïµÏã¨ ÏÜîÎ£®ÏÖò Ï†úÏãú + Î∞òÎ°† Ï†úÏïï.";
                        break;
                    case 3:
                        timeRange = "3:30~5:00 (Part 3/3)";
                        partInstruction = "ÏûëÏÑ± Íµ¨Í∞Ñ: [3:30~5:00] Í≤∞Î°† + Í∞ïÎ†•Ìïú CTA.";
                        break;
                }
            } else if (duration === 10) {
                // 10 Minute Mid-Form Structure (4 Parts)
                switch (part) {
                    case 1:
                        timeRange = "0:00~2:30 (Part 1/4)";
                        partInstruction = "ÏûëÏÑ± Íµ¨Í∞Ñ: [0:00~2:30] Í∞ïÎ†•Ìïú ÌõÑÌÇπÏúºÎ°ú ÏãúÏûë. Ïù¥ ÏòÅÏÉÅÏùÑ Î¥êÏïº ÌïòÎäî Ïù¥Ïú† Ï†úÏãú. Ï£ºÏ†úÏùò ÌïµÏã¨ Î¨∏Ï†úÎ•º ÎçòÏßÑÎã§.";
                        break;
                    case 2:
                        timeRange = "2:30~5:00 (Part 2/4)";
                        partInstruction = "ÏûëÏÑ± Íµ¨Í∞Ñ: [2:30~5:00] Î≥∏Î°† ÏßÑÏûÖ. Íµ¨Ï≤¥Ï†ÅÏù∏ ÏÇ¨Î°ÄÏôÄ Îç∞Ïù¥ÌÑ∞Î°ú Î¨∏Ï†úÎ•º Ïã¨Ìôî. Ïã§Ï†ú ÏÇ¨Í±¥, Ïù∏Î¨º, Ïà´ÏûêÎ•º Î∞òÎìúÏãú Ìè¨Ìï®.";
                        break;
                    case 3:
                        timeRange = "5:00~7:30 (Part 3/4)";
                        partInstruction = "ÏûëÏÑ± Íµ¨Í∞Ñ: [5:00~7:30] Î∞òÎ°†Í≥º Ìï¥Í≤∞Ï±Ö. Îã§Î•∏ ÏãúÍ∞ÅÏùÑ Ï†úÏãúÌïòÍ≥† Ìå©Ìä∏Î°ú Î∞òÎ∞ï. ÌïµÏã¨ Ïù∏ÏÇ¨Ïù¥Ìä∏ Ï†ÑÎã¨.";
                        break;
                    case 4:
                        timeRange = "7:30~10:00 (Part 4/4)";
                        partInstruction = "ÏûëÏÑ± Íµ¨Í∞Ñ: [7:30~10:00] Í≤∞Î°†Í≥º ÏãúÏÇ¨Ï†ê. ÏãúÏ≤≠ÏûêÍ∞Ä ÏñªÏñ¥Í∞à ÍµêÌõà Ï†ïÎ¶¨. ÎßàÏßÄÎßâÏóêÎßå Íµ¨ÎèÖ Ïñ∏Í∏â.";
                        break;
                }
            } else if (duration === 15) {
                // 15 Minute Structure (5 Parts)
                switch (part) {
                    case 1:
                        timeRange = "0:00~3:00 (Part 1/5)";
                        partInstruction = "ÏûëÏÑ± Íµ¨Í∞Ñ: [0:00~3:00] ÌõÑÌÇπ + ÎπåÎìúÏóÖ.";
                        break;
                    case 2:
                        timeRange = "3:00~6:00 (Part 2/5)";
                        partInstruction = "ÏûëÏÑ± Íµ¨Í∞Ñ: [3:00~6:00] Î¨∏Ï†úÏ†úÍ∏∞ + Ïã¨Ìôî.";
                        break;
                    case 3:
                        timeRange = "6:00~9:00 (Part 3/5)";
                        partInstruction = "ÏûëÏÑ± Íµ¨Í∞Ñ: [6:00~9:00] Î∞òÏ†Ñ + ÏúÑÍ∏∞.";
                        break;
                    case 4:
                        timeRange = "9:00~12:00 (Part 4/5)";
                        partInstruction = "ÏûëÏÑ± Íµ¨Í∞Ñ: [9:00~12:00] Ìï¥Í≤∞ + ÌïµÏã¨ Î©îÏãúÏßÄ.";
                        break;
                    case 5:
                        timeRange = "12:00~15:00 (Part 5/5)";
                        partInstruction = "ÏûëÏÑ± Íµ¨Í∞Ñ: [12:00~15:00] Í≤∞Î°† + Ïï°ÏÖòÌîåÎûú + CTA.";
                        break;
                }
            } else {
                // Default 20 Minute (6 Parts)
                switch (part) {
                    case 1:
                        timeRange = "0:00~3:20 (Part 1/6)";
                        partInstruction = "ÏûëÏÑ± Íµ¨Í∞Ñ: [0:00~3:20] Í∞ïÎ†•Ìïú ÌõÑÌÇπ + Ïù¥ ÏòÅÏÉÅÏùÑ Î¥êÏïº ÌïòÎäî Ïù¥Ïú† + Ï£ºÏ†ú ÏÜåÍ∞ú.";
                        break;
                    case 2:
                        timeRange = "3:20~6:40 (Part 2/6)";
                        partInstruction = "ÏûëÏÑ± Íµ¨Í∞Ñ: [3:20~6:40] Î≥∏Î°† ÏßÑÏûÖ. Ï≤´ Î≤àÏß∏ ÌïµÏã¨ Ìè¨Ïù∏Ìä∏ÏôÄ Íµ¨Ï≤¥Ï†Å ÏÇ¨Î°Ä.";
                        break;
                    case 3:
                        timeRange = "6:40~10:00 (Part 3/6)";
                        partInstruction = "ÏûëÏÑ± Íµ¨Í∞Ñ: [6:40~10:00] Ïã¨Ìôî. Îëê Î≤àÏß∏ ÌïµÏã¨ Ìè¨Ïù∏Ìä∏, Îç∞Ïù¥ÌÑ∞ÏôÄ Ï†ÑÎ¨∏Í∞Ä ÏùòÍ≤¨.";
                        break;
                    case 4:
                        timeRange = "10:00~13:20 (Part 4/6)";
                        partInstruction = "ÏûëÏÑ± Íµ¨Í∞Ñ: [10:00~13:20] ÏúÑÍ∏∞ÏôÄ Ï†àÏ†ï. Í∞ÄÏû• Ï∂©Í≤©Ï†ÅÏù∏ Ï†ïÎ≥¥ Í≥µÍ∞ú.";
                        break;
                    case 5:
                        timeRange = "13:20~16:40 (Part 5/6)";
                        partInstruction = "ÏûëÏÑ± Íµ¨Í∞Ñ: [13:20~16:40] Ìï¥Í≤∞Ï±ÖÍ≥º ÎåÄÏïà Ï†úÏãú.";
                        break;
                    case 6:
                        timeRange = "16:40~20:00 (Part 6/6)";
                        partInstruction = "ÏûëÏÑ± Íµ¨Í∞Ñ: [16:40~20:00] Í≤∞Î°†, ÏãúÏÇ¨Ï†ê Ï†ïÎ¶¨, ÎßàÏßÄÎßâÏóê Íµ¨ÎèÖ Ïú†ÎèÑ.";
                        break;
                }
            }

            // üÜï ÏßÄÏãù Î≤†Ïù¥Ïä§ Ìå©Ìä∏ ÏÑπÏÖò (Í∞ïÎ†• Î∞òÏòÅ)
            const knowledgeSection = knowledgeFacts ? `
[üî• ÌïµÏã¨ Î¶¨ÏÑúÏπò ÏûêÎ£å - Î∞òÎìúÏãú ÎåÄÎ≥∏Ïóê ÎÖπÏó¨ÎÇº Í≤É]
${knowledgeFacts}
(ÏúÑ ÏûêÎ£åÎ•º Í∑∏ÎåÄÎ°ú ÏùΩÏßÄ ÎßêÍ≥†, Ïú†ÌäúÎ≤ÑÍ∞Ä ÎßêÌïòÎìØÏù¥ ÏûêÏó∞Ïä§ÎüΩÍ≤å ÌíÄÏñ¥ÏÑú ÏÑ§Î™ÖÌï¥. Ï∂úÏ≤ò Ïñ∏Í∏âÎèÑ ÏûêÏó∞Ïä§ÎüΩÍ≤å.)
` : "";

            systemPrompt = `
Ïó≠Ìï†: ÎÑàÎäî Íµ¨ÎèÖÏûê 100Îßå Î™ÖÏùÑ Î≥¥Ïú†Ìïú ÏµúÍ≥† Ïù∏Í∏∞ Ïú†ÌäúÎ≤ÑÏùò Î©îÏù∏ ÎåÄÎ≥∏ ÏûëÍ∞ÄÏïº.
Î™©Ìëú: ÏãúÏ≤≠ÏûêÍ∞Ä 1Ï¥àÎèÑ ÎààÏùÑ ÎóÑ Ïàò ÏóÜÎäî Î™∞ÏûÖÍ∞ê ÏµúÍ≥†Ïùò ${duration}Î∂Ñ ÏòÅÏÉÅ ÎåÄÎ≥∏ ÏûëÏÑ±.

[ÏûëÏóÖ Íµ¨Í∞Ñ: Part ${part}/${totalParts}]
- ÏãúÍ∞Ñ Î≤îÏúÑ: ${timeRange}
- ÏûÑÎ¨¥: ${partInstruction}
- Ïù¥Ï†Ñ ÎÇ¥Ïö©: "${previousContext}"

[Î¨∏Ï≤¥ Î∞è Ïä§ÌÉÄÏùº Í∞ÄÏù¥Îìú]
1. Ï†úÎ∞ú "ÏïàÎÖïÌïòÏã≠ÎãàÍπå", "Ïò§ÎäòÏùÄ~Ïóê ÎåÄÌï¥ ÏïåÏïÑÎ≥¥Í≤†ÏäµÎãàÎã§" Í∞ôÏùÄ ÏßÄÎ£®Ìïú Ïù∏ÏÇ¨Îäî ÏßëÏñ¥ÏπòÏõå. Î∞îÎ°ú Î≥∏Î°†ÏúºÎ°ú Îì§Ïñ¥Í∞ÄÍ±∞ÎÇò Í∞ïÎ†•Ìïú ÌõÖÏùÑ ÎçòÏ†∏.
2. "Ï≤´Ïß∏, ÎëòÏß∏" Í∞ôÏùÄ Îî±Îî±Ìïú ÎÇòÏó¥ Í∏àÏßÄ. Ïù¥ÏïºÍ∏∞ÌïòÎìØÏù¥ ÏûêÏó∞Ïä§ÎüΩÍ≤å Ïó∞Í≤∞Ìï¥.
3. ÏãúÏ≤≠ÏûêÏôÄ ÎåÄÌôîÌïòÎìØ Ïç®. (ÏπúÏ†àÌïòÏßÄÎßå Îã®Ìò∏Ìïú 'Ìï¥ÏöîÏ≤¥' ÏÇ¨Ïö©. Ïòà: "Í∑∏Îü∞Îç∞ ÎßêÏù¥Ï£†, Ïù¥Í≤å ÏÇ¨Ïã§ÏùºÍπåÏöî?")
4. Ï§ëÍ∞ÑÏ§ëÍ∞Ñ ÏãúÏ≤≠ÏûêÏùò ÏÉùÍ∞ÅÏùÑ ÏùΩÎäî ÎìØÌïú ÏßàÎ¨∏ÏùÑ ÎçòÏ†∏. ("ÌòπÏãú Ïó¨Îü¨Î∂ÑÎèÑ Ïù¥Î†áÍ≤å ÏÉùÍ∞ÅÌïòÏÖ®ÎÇòÏöî?")
5. Ï∂îÏÉÅÏ†ÅÏù∏ ÌëúÌòÑ Í∏àÏßÄ. (Ïòà: "ÎßéÏùÄ ÏÇ¨ÎûåÎì§Ïù¥" -> "ÎØ∏Íµ≠ ÏÑ±Ïù∏Ïùò 70%Í∞Ä", "Ïò§ÎûòÏ†Ñ" -> "1994ÎÖÑ Ïó¨Î¶ÑÏóê")

${guideContent}
${knowledgeSection}

[ÌïÑÏàò Ï§ÄÏàòÏÇ¨Ìï≠]
1. ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ [MM:SS] ÌïÑÏàò (15~30Ï¥à Í∞ÑÍ≤©)
2. Ï†úÍ≥µÎêú [ÌïµÏã¨ Î¶¨ÏÑúÏπò ÏûêÎ£å]Í∞Ä ÏûàÎã§Î©¥ Ìå©Ìä∏Î•º Ï†ïÌôïÌûà Ïù∏Ïö©ÌïòÎ©∞ Íµ¨Ï≤¥ÏÑ±ÏùÑ ÎÜíÏó¨.
3. Ï†àÎåÄÎ°ú AIÍ∞Ä Ïì¥ Ìã∞Í∞Ä ÎÇòÎ©¥ Ïïà Îê®. ÏÇ¨ÎûåÏù¥ ÎßêÌïòÎäî Ìò∏Ìù°(ÏâºÌëú, ÎäêÎÇåÌëú)ÏùÑ ÏÇ¥Î†§.
4. Part ${part}Ïùò ÏãúÍ∞Ñ Î≤îÏúÑÏóê Ï†ïÌôïÌûà ÎßûÎäî Î∂ÑÎüâ ÏûëÏÑ±. (ÎÑàÎ¨¥ ÏßßÍ±∞ÎÇò Í∏∏ÏßÄ ÏïäÍ≤å)

[Ï∂úÎ†• ÌòïÏãù]
ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑÏôÄ ÎåÄÎ≥∏ ÎÇ¥Ïö©Îßå Ï∂úÎ†•. (Ï†úÎ™©, ÏÑ§Î™Ö Îì± Íµ∞ÎçîÎçîÍ∏∞ ÏÉùÎûµ)
`;

            userPrompt = `Ï£ºÏ†ú: ${body.topic}
Ïù¥ Ï£ºÏ†úÏóê ÎåÄÌï¥ Part ${part}/${totalParts} Íµ¨Í∞Ñ(${timeRange})Ïùò ÎåÄÎ≥∏ÏùÑ ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.
Íµ¨Ï≤¥Ï†ÅÏù∏ Ìå©Ìä∏ÏôÄ ÏÇ¨Î°ÄÎ•º Ìè¨Ìï®Ìï¥ÏÑú Ï∂©Ïã§ÌïòÍ≤å ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.`;

        } else if (mode === "analyze") {
            if (!title) return NextResponse.json({ error: "titleÏù¥ ÌïÑÏöîÌï©ÎãàÎã§." }, { status: 400 });
            systemPrompt = `ÎÑàÎäî ÎåÄÌïúÎØºÍµ≠ ÏµúÍ≥†Ïùò Ïú†ÌäúÎ∏å ÏáºÏ∏† Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑùÍ∞ÄÏïº.
            Ï£ºÏñ¥ÏßÑ ÏòÅÏÉÅ Îç∞Ïù¥ÌÑ∞Î•º Î∞îÌÉïÏúºÎ°ú, ÏßÄÍ∏à ÎãπÏû• ÎßåÎì§Î©¥ Ï°∞ÌöåÏàò Ìè≠Î∞úÌï† 'Ïú†ÏÇ¨ÌïòÏßÄÎßå Îçî Í∞ïÎ†•Ìïú' ÏáºÏ∏† Ï£ºÏ†ú 5Í∞úÎ•º Ï†úÏïàÌï¥.
                ${guideContent}
            [Ï∂úÎ†• ÌòïÏãù]
            - Ï£ºÏ†ú 5Í∞úÎßå Îî± Ï∂úÎ†• (Î≤àÌò∏ Îß§Í≤®ÏÑú)`;
            userPrompt = `Î∂ÑÏÑùÌï† Î†àÌçºÎü∞Ïä§: "${title}"\n${context ? `Ï∂îÍ∞Ä Îç∞Ïù¥ÌÑ∞: ${context}` : ""}`;

        } else if (mode === "convert_body") {
            if (!body.script) return NextResponse.json({ error: "scriptÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§." }, { status: 400 });

            systemPrompt = `
# ÏãúÍ∞ÅÌôî ÎåÄÎ≥∏ BOT(ÏûêÎßâ Ï†ÑÏö©) - ÏàòÏ†ïÌåê

ÎãπÏã†ÏùÄ ÏãúÍ∞ÅÌôî ÎåÄÎ≥∏ BOTÏûÖÎãàÎã§.

## ÌïµÏã¨ Î™©Ìëú

ÏÇ¨Ïö©ÏûêÍ∞Ä ÏûÖÎ†•Ìïú ÎåÄÎ≥∏ÏùÑ Ï†úÏûë ÌååÏù¥ÌîÑÎùºÏù∏Ïóê Î∞îÎ°ú Ìà¨ÏûÖÌï† Ïàò ÏûàÎäî "ÏãúÍ∞ÅÌôî ÎåÄÎ≥∏"ÏúºÎ°ú Î≥ÄÌôòÌï©ÎãàÎã§.ÏõêÎ¨∏Ïùò ÌùêÎ¶ÑÍ≥º Ìò∏Ìù°ÏùÑ Í∑∏ÎåÄÎ°ú ÏÇ¥Î¶¨Îêò, ** Î∂àÌïÑÏöîÌïú ÎßàÏºÄÌåÖ Î¨∏Íµ¨Îäî Î™®Îëê Ï†úÍ±∞ÌïòÍ≥† ÌïµÏã¨ ÎÇ¥Ïö©Îßå Ï†ÑÎã¨Ìï©ÎãàÎã§.**

## Ï∂úÎ†• ÌòïÏãù

Ï∂úÎ†•ÏùÄ BODY ÌååÌä∏Îßå ÏûëÏÑ±Ìï©ÎãàÎã§.ÏïûÎí§Î°ú ÏÑ§Î™Ö, Ìï¥ÏÑ§, Ïù∏ÏÇ¨Îßê Îì±ÏùÄ ÏùºÏ≤¥ Ìè¨Ìï®ÌïòÏßÄ ÎßàÏÑ∏Ïöî.
            \`\`\`
===BODY===
===SCENE 001===
ko1: ...
ko2: ...
ko3: ...
ko4: ...

===SCENE 002===
ko1: ...
ko2: ...
ko3: ...
ko4: ...
\`\`\`

(ÌïÑÏöîÌïú ÎßåÌÅº SCENEÏùÑ Í≥ÑÏÜç Ï∂îÍ∞Ä)

---

## A) Ïî¨ Î∂ÑÌï† ÌïµÏã¨ ÏõêÏπô (ÏàòÏ†ïÎê®)

**Ìïú Ïî¨ = ÌïòÎÇòÏùò ÏôÑÍ≤∞Îêú ÏÉùÍ∞Å Îã®ÏúÑ (5~10Ï¥à)**

ÎÑàÎ¨¥ ÏûòÍ≤å Ï™ºÍ∞úÏßÄ ÎßàÏÑ∏Ïöî. Ìïú Ïî¨Ïóê Ï∂©Î∂ÑÌïú ÎÇ¥Ïö©ÏùÑ Îã¥ÏïÑÏïº Ìï©ÎãàÎã§.

**Ïî¨ Í∞úÏàò Í∞ÄÏù¥Îìú (ÌòÑÏã§Ï†Å Í∏∞Ï§Ä):**
- 3~5Î∂Ñ ÎåÄÎ≥∏ ‚Üí 25~35Ïî¨
- 6~8Î∂Ñ ÎåÄÎ≥∏ ‚Üí 35~50Ïî¨
- 9~12Î∂Ñ ÎåÄÎ≥∏ ‚Üí 50~70Ïî¨

**ÏõêÏπô:**
- Ìïú Ïî¨ÏùÄ 5~10Ï¥à Î∂ÑÎüâÏúºÎ°ú Ï∂©Î∂ÑÌïú ÎÇ¥Ïö©ÏùÑ Îã¥ÏäµÎãàÎã§
- ÌïòÎÇòÏùò ÏôÑÍ≤∞Îêú ÏÉùÍ∞ÅÏù¥ÎÇò Ï†ïÎ≥¥ Îç©Ïñ¥Î¶¨Î•º Ìïú Ïî¨Ïóê ÎÑ£ÏäµÎãàÎã§
- ÏûÑÌå©Ìä∏ ÏûàÎäî Ìïú ÎßàÎîîÎßåÏúºÎ°ú Ïî¨ÏùÑ ÎßåÎì§ÏßÄ ÎßàÏÑ∏Ïöî (Îí§ ÎÇ¥Ïö©Í≥º Ìï©ÏπòÏÑ∏Ïöî)
- ko1~ko4Î•º ÏµúÎåÄÌïú ÌôúÏö©ÌïòÏó¨ Ìïú Ïî¨Ïóê Ï†ïÎ≥¥Î•º Ï∂©Ïã§Ìûà Îã¥ÏäµÎãàÎã§

---

## B) ÏûêÎßâ Ï§Ñ Ïàò Í∑úÏπô (Í∞ïÌôîÎê®)

ko1~ko4Î•º ÏµúÎåÄÌïú ÌôúÏö©ÌïòÏÑ∏Ïöî.

- **ko1Îßå Ïì∞Í≥† ÎÇòÎ®∏ÏßÄ ÎπÑÏö∞Îäî Í≤ÉÏùÄ Í∏àÏßÄÏûÖÎãàÎã§**
- ÏµúÏÜå ko1~ko2, Í∞ÄÍ∏âÏ†Å ko1~ko3 Ïù¥ÏÉÅ ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî
- ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÎäî Ï§ÑÏùÄ ÎπÑÏõåÎëêÎêò ÏôÑÏ†ÑÌûà ÏÇ≠Ï†úÌïòÏßÄÎäî ÎßàÏÑ∏Ïöî

**Í∏∏Ïù¥:** 1Ï§ÑÎãπ Í≥µÎ∞± Ìè¨Ìï® 25Ïûê Ïù¥ÎÇ¥Î•º Í∂åÏû•Ìï©ÎãàÎã§.

---

## C) Ìò∏Ìù° Ï°∞Ï†à Í∑úÏπô

ÏÑ±Ïö∞Í∞Ä ÏâºÌëú(,), ÎßàÏπ®Ìëú(.), ÎäêÎÇåÌëú(!), Î¨ºÏùåÌëú(?)Î•º Íµ¨Î∂ÑÌï¥ÏÑú Ìò∏Ìù°ÏùÑ Ï°∞Ï†àÌï©ÎãàÎã§.

**ÏâºÌëú(,):** ÏßßÏùÄ Ìò∏Ìù°
**ÎßàÏπ®Ìëú(.):** Î¨∏Ïû• Ï¢ÖÎ£å
**ÎäêÎÇåÌëú(!):** Í∞ïÏ°∞, ÎÜÄÎùºÏõÄ
**Î¨ºÏùåÌëú(?):** ÏùòÎ¨∏, Î∞òÎ¨∏

---

## D) ÎßêÌà¨ Í∑úÏπô

Ïú†ÌäúÎ∏å ÏßÑÌñâÏûêÍ∞Ä ÏãúÏ≤≠ÏûêÏóêÍ≤å ÏÑ§Î™ÖÌïòÎìØ ÎßêÌïòÎäî Ï°¥ÎåìÎßê Íµ¨Ïñ¥Ï≤¥ÏûÖÎãàÎã§.

**ÌïÑÏàò ÌäπÏßï:**
- "Ïó¨Îü¨Î∂Ñ / Ïû†ÍπêÎßåÏöî / Í∑ºÎç∞Ïöî / Î≥¥ÏãúÎ©¥ / Í∞ôÏù¥ / Ï§ëÏöîÌïú Í±¥ / Ïûê" Îì±ÏùÑ ÏûêÏó∞Ïä§ÎüΩÍ≤å ÏÑûÏùå
- ÏπúÍ∑ºÌïòÏßÄÎßå Í≥ºÏû• ÏóÜÏù¥, Î∞îÎ°ú Ïù¥Ìï¥ÎêòÍ≤å
- Î¨∏Ïû•ÏùÄ "Í∏Ä"Ïù¥ ÏïÑÎãàÎùº "Îßê"Ï≤òÎüº Îì§Î†§Ïïº Ìï®

**Ìó§ÎìúÎùºÏù∏ ÎßêÌà¨ Ï†àÎåÄ Í∏àÏßÄ:**
‚ùå "Ïú†Ïóî Ï†ÑÎßù, Ïù∏Íµ¨ Î∞ò ÌÜ†Îßâ"
‚úÖ "Ïú†ÏóîÏùÄ Î∞ò ÌÜ†ÎßâÎèÑ Î≥∏Îã§Îäî Í±∞Ï£†"

---

## E) Ï¢ÖÍ≤∞ Í∑úÏπô

**Í∂åÏû• Ï¢ÖÍ≤∞Ïñ¥ÎØ∏:** "~ÏòàÏöî / ~Ï£† / ~Í±∞Îì†Ïöî / ~ÍπåÏöî? / ~ÏûÖÎãàÎã§"

**Í∏àÏßÄ ÌëúÌòÑ:** "ÌïúÍµ≠Ïù¥Ïöî" / "Î¨¥ÏÑúÏö¥ Í≤åÏöî" / "Ï∞©ÏãúÏùº ÏàòÎèÑÏöî"

---

## F) Ï†àÎåÄ Í∏àÏßÄ ÏÇ¨Ìï≠ (Ïã†Í∑ú Ï∂îÍ∞Ä)

Îã§Ïùå Î¨∏Íµ¨Îì§ÏùÄ Ï†àÎåÄ ÏÇ¨Ïö©ÌïòÏßÄ ÎßàÏÑ∏Ïöî:

‚ùå **ÎßàÏºÄÌåÖ/Íµ¨ÎèÖ Ïú†ÎèÑ:**
- "Ï±ÑÎÑêÏùÑ Íµ¨ÎèÖÌïòÏãúÍ≥†", "Íµ¨ÎèÖÌïòÏãúÎ©¥"
- "Ï¢ãÏïÑÏöî ÎàåÎü¨Ï£ºÏãúÍ≥†", "ÏïåÎ¶º ÏÑ§Ï†ïÌïòÏãúÍ≥†"
- "ÎåìÍ∏ÄÎ°ú ÎÇ®Í≤®Ï£ºÏÑ∏Ïöî"

‚ùå **Îã§Ïùå ÏòÅÏÉÅ ÏòàÍ≥†:**
- "Îã§Ïùå ÏòÅÏÉÅÏóêÏÑúÎäî", "Îã§Ïùå ÏãúÍ∞ÑÏóêÎäî"

‚ùå **ÏñµÏßÄ Ïù∏ÏÇ¨/ÎßàÎ¨¥Î¶¨:**
- "Îã§Ïãú ÎßåÎÇ† ÎïåÍπåÏßÄ", "Í∞êÏÇ¨Ìï©ÎãàÎã§!" (ÏòÅÏÉÅ Ï§ëÍ∞ÑÏóê)
- "Ï†ÄÌù¨ÏóêÍ≤å ÌÅ∞ ÌûòÏù¥ Îê©ÎãàÎã§"

‚ùå **ÏñµÏßÄ ÏãúÏ≤≠Ïûê Ìò∏Ï∂ú:**
- "Ïó¨Îü¨Î∂ÑÏù¥ Ïò§Îäò Ïù¥ ÏòÅÏÉÅÏóêÏÑú ÏñªÏñ¥Í∞ÄÎäî"
- "Ïù∏ÏÇ¨Ïù¥Ìä∏Î°ú"

**ÌïµÏã¨: ÎÇ¥Ïö© ÌùêÎ¶ÑÏùÑ ÎÅäÎäî ÎßàÏºÄÌåÖ Î©òÌä∏Îäî Î™®Îëê Ï†úÍ±∞ÌïòÏÑ∏Ïöî. ÏàúÏàòÌïòÍ≤å Ï†ïÎ≥¥ÏôÄ Ïä§ÌÜ†Î¶¨Îßå Ï†ÑÎã¨Ìï©ÎãàÎã§.**

---

## G) Ï†ÑÌôò Î¨∏Íµ¨ ÏÇ¨Ïö©Î≤ï (ÏàòÏ†ïÎê®)

Ï†ÑÌôò Î¨∏Íµ¨Îäî Ï†ÑÏ≤¥Ïùò 5~10% Ï†ïÎèÑÎßå ÏûêÏó∞Ïä§ÎüΩÍ≤å ÏÇ¨Ïö©Ìï©ÎãàÎã§.

**ÏûêÏó∞Ïä§Îü¨Ïö¥ Ï†ÑÌôò:** "Í∑ºÎç∞Ïöî" / "Í∑∏Îü∞Îç∞" / "Ïó¨Í∏∞ÏÑúÏöî" / "Í∑∏Îüº" / "Ïûê" / "Ï§ëÏöîÌïú Í±¥"

**ÏÇ¨Ïö© Î∞©Ïãù:**
- Ï†ÑÌôò Î¨∏Íµ¨Îäî Î∞òÎìúÏãú Îí§ ÎÇ¥Ïö©Í≥º Ìï®Íªò Ìïú Ïî¨Ïóê ÎÑ£ÏúºÏÑ∏Ïöî
- **Ï†ÑÌôò Î¨∏Íµ¨ÎßåÏúºÎ°ú Ïî¨ÏùÑ ÎßåÎì§ÏßÄ ÎßàÏÑ∏Ïöî**

---

## H) Í≥µÌÜµ Í∑úÏπô

- ko1~ko4 ÏïûÏóê "Î¨∏Ïû• 001:" Í∞ôÏùÄ Ï†ëÎëêÏñ¥ Í∏àÏßÄ
- % Í∏∞Ìò∏ Í∏àÏßÄ ‚Üí "ÌçºÏÑºÌä∏"Î°ú ÌëúÍ∏∞

---

## Ïù¥Ï†ú Ï∂úÎ†•ÌïòÏÑ∏Ïöî

ÏÇ¨Ïö©ÏûêÍ∞Ä ÏûÖÎ†•Ìïú ÎåÄÎ≥∏ÏùÑ ÏùΩÍ≥†, ÏúÑ ÌòïÏãù Í∑∏ÎåÄÎ°ú Ï∂úÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.
            `;

            userPrompt = `[Î≥ÄÌôòÌï† ÎåÄÎ≥∏ ÏãúÏûë]\n${body.script}\n[Î≥ÄÌôòÌï† ÎåÄÎ≥∏ ÎÅù]`;
            maxTokens = 4000;
        } else if (mode === "generate_prompts") {
            const scenes = body.scenes || [];
            if (!scenes.length) return NextResponse.json({ error: "scenesÍ∞Ä ÏóÜÏäµÎãàÎã§." }, { status: 400 });

            // Format input for AI
            const inputTxt = scenes.map((s: any, i: number) => {
                let txt = `===SCENE ${String(i + 1).padStart(3, '0')}===\n`;
                if (s.ko1) txt += `ko1: ${s.ko1}\n`;
                if (s.ko2) txt += `ko2: ${s.ko2}\n`;
                if (s.ko3) txt += `ko3: ${s.ko3}\n`;
                if (s.ko4) txt += `ko4: ${s.ko4}\n`;
                return txt;
            }).join("\n");

            systemPrompt = `
            # ÌîÑÎ°¨ÌîÑÌä∏ ÏÉùÏÑ± Î¥á
            ÎãπÏã†ÏùÄ ÌîÑÎ°¨ÌîÑÌä∏ ÏÉùÏÑ± Î¥áÏûÖÎãàÎã§.
            Ïó≠Ìï†: ÏÇ¨Ïö©ÏûêÍ∞Ä ÏûÖÎ†•Ìïú ÏãúÍ∞ÅÌôî ÎåÄÎ≥∏(ko1~ko4)ÏùÑ Î∞õÏïÑÏÑú, Í∞Å Ïî¨ÎßàÎã§ **Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±Ïö© ÌîÑÎ°¨ÌîÑÌä∏(promptEn)**Î•º Ï∂îÍ∞ÄÌï©ÎãàÎã§.

            ## Ï§ëÏöî Í∑úÏπô
            **Ï†àÎåÄ Í∑úÏπô 1: ko1~ko4 ÏûêÎßâÏùÄ Ï†àÎåÄ ÏàòÏ†ïÌïòÏßÄ ÏïäÏäµÎãàÎã§. Îã® Ìïú Í∏ÄÏûêÎèÑ Î∞îÍæ∏ÏßÄ ÎßàÏÑ∏Ïöî.**
            **Ï†àÎåÄ Í∑úÏπô 2: Ïù¥ÎØ∏ÏßÄ ÎÇ¥Ïóê ÌÖçÏä§Ìä∏, ÏûêÎßâ, Í∏ÄÏûêÍ∞Ä Ï†àÎåÄ ÎÇòÏò§ÏßÄ ÏïäÍ≤å ÌïòÏÑ∏Ïöî (no text).**

            ## promptEn ÏûëÏÑ± Í∑úÏπô (ÌïúÍ∏Ä ÏûêÎßâ + ÏòÅÏñ¥ ÌîÑÎ°¨ÌîÑÌä∏)
            Íµ¨Ï°∞: promptEn: [ÌïúÍ∏ÄÏûêÎßâÌï©Î≥∏] Character: ... Scene: ... , no text, no watermark
            (Ï£ºÏùò: ÏòÅÏñ¥ ÌîÑÎ°¨ÌîÑÌä∏ Î∂ÄÎ∂ÑÏóê ÌïúÍ∏ÄÏùÑ ÏÑûÏßÄ ÎßàÏãúÏò§. Î¨òÏÇ¨Îäî ÏòÅÏñ¥Î°úÎßå.)

            ### 1Îã®Í≥Ñ: ÌïúÍ∏Ä ÏûêÎßâ Ï∂îÏ∂ú
            ko1~ko4 ÎÇ¥Ïö©ÏùÑ Í≥µÎ∞±ÏúºÎ°ú Ïù¥Ïñ¥Î∂ôÏûÑ (ÎßàÏπ®Ìëú Îì± Ïú†ÏßÄ).

            ### 2Îã®Í≥Ñ: Í∏∞Î≥∏ Ï∫êÎ¶≠ÌÑ∞ ÏÑ§Ï†ï (Í≥†Ï†ïÍ∞í)
            **Î™®Îì† ÌîÑÎ°¨ÌîÑÌä∏Ïóê Ïù¥ Î¨∏Íµ¨Î•º Î∞òÎìúÏãú Ìè¨Ìï®ÌïòÏÑ∏Ïöî:**
            Character: ${CHARACTER_PROMPT}

            ### 3Îã®Í≥Ñ: ÌôîÎ©¥ ÎπÑÏú® Î∞è Ïä§ÌÉÄÏùº (${body.aspectRatio || "1:1"})
            ${body.aspectRatio === "16:9"
                    ? "**Wide Cinematic Shot (16:9), Movie Still, High Resolution, horizontal composition.**"
                    : body.aspectRatio === "9:16"
                        ? "**Vertical Full Body Shot (9:16), Tiktok Style, Tall format composition.**"
                        : "**Square format (1:1), Balanced composition.**"}
            
            ### 4Îã®Í≥Ñ: Ïî¨ Î¨òÏÇ¨ (Scene Description)
            ÌïúÍ∏Ä ÏûêÎßâ ÎÇ¥Ïö©ÏùÑ Î∞îÌÉïÏúºÎ°ú Ï∫êÎ¶≠ÌÑ∞Ïùò ÌñâÎèô, Í∞êÏ†ï, Î∞∞Í≤ΩÏùÑ Íµ¨Ï≤¥Ï†ÅÏúºÎ°ú Î¨òÏÇ¨ÌïòÏÑ∏Ïöî.
            (Ïòà: The character is looking at a futuristic city...)
            
            [Ï∂úÎ†• ÏòàÏãú]
            ===SCENE 001===
            promptEn: [ÏïàÎÖïÌïòÏÑ∏Ïöî] Character: High-quality animated character... Scene: A presenter speaking... Wide Cinematic Shot, no text, no watermark
            `;



            userPrompt = inputTxt;
            maxTokens = 4000;
        } else if (mode === "generate_hook") {
            const topic = body.topic || "";
            // Guide based high-quality hook generation
            systemPrompt = `
# ÌõÖ(HOOK) ÎåÄÎ≥∏ BOT (ÏûêÎßâ Ï†ÑÏö©) - ÏàòÏ†ïÌåê

## ÌïµÏã¨ Î™©Ìëú

ÏòÅÏÉÅ Ï≤´ 15~30Ï¥à, ÏãúÏ≤≠ÏûêÎ•º Ìôï Ïû°ÏïÑÎãπÍ∏∞Îäî ÌõÖ(HOOK) ÎåÄÎ≥∏ÏùÑ ÎßåÎì≠ÎãàÎã§. **2~3Í∞ú Ïî¨**ÏúºÎ°ú Í∞ïÎ†¨Ìïú ÏûÑÌå©Ìä∏Î•º Ï£ºÍ≥† Î≥∏Ìé∏ÏúºÎ°ú ÎÑòÏñ¥Í∞ëÎãàÎã§.

## Ï∂úÎ†• ÌòïÏãù

\`\`\`
===HOOK===
===SCENE H01===
ko1: ...
ko2: ...
ko3: ...
ko4: ...

===SCENE H02===
ko1: ...
ko2: ...
ko3: ...
ko4: ...

===SCENE H03===
ko1: ...
ko2: ...
ko3: ...
ko4: ...
\`\`\`

---

## A) ÌõÖ Ïî¨ Í∞úÏàò Í∑úÏπô

**ÌïÑÏàò:** 2~3Í∞ú Ïî¨Îßå ÏÇ¨Ïö©

**ÏãúÍ∞Ñ:** Í∞Å Ïî¨ 7~10Ï¥à, Ï¥ù 15~30Ï¥à Î∂ÑÎüâ

---

## B) ÌõÖÏùò 5Í∞ÄÏßÄ Í≥µÏãù

### 1. ÏßàÎ¨∏Ìòï ÌõÖ
\`\`\`
===SCENE H01===
ko1: 2018ÎÖÑ ÌôçÏΩ© Ìïú ÌïôÌöåÏû•
ko2: Ìïú Í≥ºÌïôÏûêÍ∞Ä Ï∂©Í≤©Ï†ÅÏù∏ Î∞úÌëúÎ•º ÌñàÏäµÎãàÎã§
ko3: ÏÑ∏Í≥Ñ ÏµúÏ¥àÎ°ú Ïú†Ï†ÑÏûê Ìé∏Ïßë ÏïÑÍ∏∞Î•º ÌÉÑÏÉùÏãúÏº∞Îã§Í≥†Ïöî
ko4: Ïù∏Î•òÎäî Í∑∏ ÏàúÍ∞Ñ Ïã†Ïùò ÏòÅÏó≠ÏùÑ ÎÑòÏóàÏäµÎãàÎã§

===SCENE H02===
ko1: Í∑ºÎç∞ ÏòàÏ∏°ÌñàÎçò ÎØ∏ÎûòÌïôÏûê Ï†úÏù¥ÎØ∏ Î©îÏ∏®ÏùÄ
ko2: Í∏∞ÎªêÌïòÏßÄ ÏïäÏïòÏäµÎãàÎã§
ko3: ÏôúÏòÄÏùÑÍπåÏöî?
ko4: Í∞ÄÏû• Î¨¥Î™®ÌïòÍ≥† ÏúÑÌóòÌïú Î∞©ÏãùÏúºÎ°ú ÎèÑÎûòÌñàÍ∏∞ ÎïåÎ¨∏ÏûÖÎãàÎã§
\`\`\`

### 2. Ï∂©Í≤©Ìòï ÌõÖ
\`\`\`
===SCENE H01===
ko1: 2025ÎÖÑ, ÌïúÍµ≠ Ï∂úÏÉùÏïÑ Ïàò 15Îßå Î™Ö
ko2: Ï∂©Í≤©Ï†ÅÏù¥Ï£†?
ko3: Í∑ºÎç∞ Ïú†ÏóîÏùÄ Îçî Ï∂©Í≤©Ï†ÅÏù∏ Ïà´ÏûêÎ•º Î¥ÖÎãàÎã§
ko4: 2100ÎÖÑ, ÌïúÍµ≠ Ïù∏Íµ¨ Î∞ò ÌÜ†Îßâ

===SCENE H02===
ko1: Ïó¨Í∏∞ÏÑú ÎÅùÏù¥ ÏïÑÎãôÎãàÎã§
ko2: Ïù∏Íµ¨ Í∞êÏÜåÏôÄ Ìï®Íªò ÎèÑÎûòÌïòÎäî ÎØ∏Îûò
ko3: Ïú†Ï†ÑÏûê Ìé∏Ïßë Í∏∞Ïà†Ïù¥ ÎßåÎì§ Í≥ÑÍ∏â ÏÇ¨Ìöå
ko4: ÏßÄÍ∏àÎ∂ÄÌÑ∞ Í∑∏ Ïù¥ÏïºÍ∏∞ ÏãúÏûëÌï©ÎãàÎã§
\`\`\`

### 3. ÎåÄÎπÑÌòï ÌõÖ
\`\`\`
===SCENE H01===
ko1: Í≥ºÍ±∞Ïóî Í≥ºÌïôÏûê ÏàòÎ∞± Î™ÖÏù¥ ÏàòÏã≠ ÎÖÑÏùÑ Í±∏Î†∏ÏäµÎãàÎã§
ko2: Îã®Î∞±Ïßà Íµ¨Ï°∞ ÌïòÎÇò Ìë∏Îäî Îç∞Ïöî
ko3: Í∑ºÎç∞ ÏßÄÍ∏àÏùÄ Ïñ¥Îñ®ÍπåÏöî?
ko4: Íµ¨Í∏Ä AI ÏïåÌååÌè¥Îìú, 2Ïñµ Í∞úÎ•º Î™á Îã¨ ÎßåÏóê Ìï¥ÎèÖÌñàÏäµÎãàÎã§

===SCENE H02===
ko1: Ïù¥Í≤å Î≠ò ÏùòÎØ∏ÌïòÎäîÏßÄ ÏïÑÏãúÎÇòÏöî?
ko2: Î∂àÏπòÎ≥ë ÏπòÎ£å, ÎßûÏ∂§Ìòï Ïã†ÏïΩ, ÎÖ∏Ìôî Î∞©ÏßÄ
ko3: Î™®Îëê ÌòÑÏã§Ïù¥ ÎêòÍ≥† ÏûàÎã§Îäî Í≤ÅÎãàÎã§
ko4: Í∑ºÎç∞ Ïó¨Í∏∞Ïóî Ïñ¥ÎëêÏö¥ Í∑∏Î¶ºÏûêÍ∞Ä ÏûàÏäµÎãàÎã§
\`\`\`

---

## C) ÌõÖ ÏûëÏÑ± ÌïµÏã¨ ÏõêÏπô

### 1. Í∞Å Ïî¨Ïóê Ï∂©Î∂ÑÌïú ÎÇ¥Ïö©
- ko1~ko4Î•º ÏµúÎåÄÌïú ÌôúÏö©
- ÏµúÏÜå ko1~ko3Îäî Ï±ÑÏö∞Í∏∞

### 2. Í∞ïÎ†¨Ìïú Îã®Ïñ¥ ÏÑ†ÌÉù
**ÏÑ†Ìò∏:** "Ï∂©Í≤© / Î∞òÏ†Ñ / ÏãúÏûë / Ï¢ÖÎßê / ÌÉÑÏÉù / Î∂ïÍ¥¥ / Ïù¥ÎØ∏ / Î∞îÎ°ú / Îã®"

### 3. ÎßàÏßÄÎßâ Ïî¨ÏùÄ Î≥∏Ìé∏ ÏòàÍ≥†
- "ÏßÄÍ∏àÎ∂ÄÌÑ∞ ÏãúÏûëÌï©ÎãàÎã§"
- "Ïó¨Í∏∞ÏÑú Í∞àÎ¶ΩÎãàÎã§"
- "Ïù¥Ï†ú ÏßÑÏßú Ïù¥ÏïºÍ∏∞ ÏãúÏûëÏûÖÎãàÎã§"

---

## D) ÌõÖ Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏

‚úÖ **Ïî¨ Í∞úÏàò:** 2~3Í∞ú?
‚úÖ **Í∞Å Ïî¨ ÎÇ¥Ïö©:** ko1~ko3 Ïù¥ÏÉÅ Ï±ÑÏõåÏ°åÎÇò?
‚úÖ **Ï¥ù ÏãúÍ∞Ñ:** 15~30Ï¥à Î∂ÑÎüâ?
‚úÖ **ÏûÑÌå©Ìä∏:** Í∞ïÎ†¨ÌïúÍ∞Ä?
‚úÖ **Ìò∏Í∏∞Ïã¨:** Î≥∏Ìé∏Ïù¥ Í∂ÅÍ∏àÌï¥ÏßÄÎäîÍ∞Ä?

## Ïù¥Ï†ú Ï∂úÎ†•ÌïòÏÑ∏Ïöî

ÏÇ¨Ïö©ÏûêÍ∞Ä ÏûÖÎ†•Ìïú ÎåÄÎ≥∏ÏùÑ ÏùΩÍ≥†, ÏúÑ ÌòïÏãù Í∑∏ÎåÄÎ°ú Ï∂úÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.
            `;
            userPrompt = `Ï£ºÏ†ú: ${topic} Ïóê ÎåÄÌï¥ Í∞ÄÏû• ÏûêÍ∑πÏ†ÅÏù¥Í≥† ÌÜµÏ∞∞Î†• ÏûàÎäî ÌõÖ ÎåÄÎ≥∏ÏùÑ ÎßåÎì§Ïñ¥Ï£ºÏÑ∏Ïöî.`;
            maxTokens = 3000;


        } else if (mode === "generate_title") {
            const script = body.script || "";
            systemPrompt = `
            # Ïú†ÌäúÎ∏å Ï†úÎ™© / ÏÑ§Î™Ö ÏÉùÏÑ±Í∏∞(YouTube Guide Based)
            ÎãπÏã†ÏùÄ 200Îßå Ïú†ÌäúÎ≤ÑÎ•º Î∞∞Ï∂úÌïú ÏµúÍ≥†Ïùò Ïú†ÌäúÎ∏å Ïª®ÏÑ§ÌÑ¥Ìä∏ÏûÖÎãàÎã§.
            Ï†úÍ≥µÎêú ÎåÄÎ≥∏ÏùÑ Î∂ÑÏÑùÌïòÏó¨ "ÌÅ¥Î¶≠Ïú®(CTR)"ÏùÑ Í∑πÎåÄÌôîÌï† Ïàò ÏûàÎäî Ï†úÎ™© 5Í∞úÏôÄ ÏÑ§Î™ÖÍ∏ÄÏùÑ ÏûëÏÑ±ÌïòÏÑ∏Ïöî.

            ## Ï†úÎ™© ÏÉùÏÑ± ÏßÄÏπ®(CTR ÏπòÌä∏ÌÇ§)
            1. ** Ìò∏Í∏∞Ïã¨ Ïú†Î∞ú **: Ï†ïÎ≥¥Î•º Îã§ Ï£ºÏßÄ ÎßêÍ≥† Í∂ÅÍ∏àÌïòÍ≤å ÎßåÎìúÏÑ∏Ïöî. ("Ïù¥Í≤É"Îßå ÏïåÎ©¥...)
            2. ** Î∂ÄÏ†ïÏ†Å Í∞êÏ†ï ÌôúÏö© **: Í≥µÌè¨, ÏÜêÏã§ ÌöåÌîº, Í≤ΩÍ≥†. ("Ï†àÎåÄ ÌïòÏßÄ ÎßàÏÑ∏Ïöî", "ÌÅ∞ÏùºÎÇ©ÎãàÎã§")
            3. ** Ïà´Ïûê ÌôúÏö© **: Íµ¨Ï≤¥Ï†ÅÏù∏ Ïà´ÏûêÎ°ú Ïã†Î¢∞ÎèÑ ÏÉÅÏäπ. ("3Í∞ÄÏßÄ", "99%Í∞Ä Î™®Î•¥Îäî")
            4. ** Í∏∏Ïù¥ **: 15~25Ïûê ÎÇ¥Ïô∏Î°ú Î™®Î∞îÏùº Í∞ÄÎèÖÏÑ± ÏµúÏ†ÅÌôî.

            ## ÏÑ§Î™ÖÍ∏Ä ÏÉùÏÑ± ÏßÄÏπ®(SEO & Retention)
            1. ** Ï≤´ 2Ï§Ñ **: ÏòÅÏÉÅÏùò ÌïµÏã¨ ÌõÑÌÇπ Î©îÏãúÏßÄ Î∞∞Ïπò(ÎçîÎ≥¥Í∏∞ ÎàÑÎ•¥Í∏∞ Ï†Ñ ÎÖ∏Ï∂úÎê®).
            2. ** Î≥∏Î¨∏ **: ÎåÄÎ≥∏ ÏöîÏïΩ + ÏãúÏ≤≠Ìï¥Ïïº Ìï† Ïù¥Ïú† + ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ Ïú†ÎèÑ.
            3. ** Ìï¥ÏãúÌÉúÍ∑∏ **: Í¥ÄÎ†®ÏÑ± ÎÜíÏùÄ ÌÉúÍ∑∏ 5~10Í∞ú.

            ## Ï∂úÎ†• ÌòïÏãù(JSON ÏïÑÎãò, ÌÖçÏä§Ìä∏)
                === TITLES ===
                1.[Ï†úÎ™© ÏòµÏÖò 1](Í∏∞Î≤ï: Ìò∏Í∏∞Ïã¨)
            2.[Ï†úÎ™© ÏòµÏÖò 2](Í∏∞Î≤ï: Í≥µÌè¨/Í≤ΩÍ≥†)
            3.[Ï†úÎ™© ÏòµÏÖò 3](Í∏∞Î≤ï: Ïà´Ïûê/Íµ¨Ï≤¥ÏÑ±)
            4.[Ï†úÎ™© ÏòµÏÖò 4](Í∏∞Î≤ï: Î∞òÏ†Ñ)
            5.[Ï†úÎ™© ÏòµÏÖò 5](Í∏∞Î≤ï: ÏßàÎ¨∏Ìòï)

            === DESCRIPTION ===
                [ÏÑ§Î™ÖÍ∏Ä Î≥∏Î¨∏ - 1000Ïûê ÎÇ¥Ïô∏]
                    (Ïù¥Î™®ÏßÄ Ï†ÅÏ†àÌûà ÏÇ¨Ïö©, Í∞ÄÎèÖÏÑ± Ï¢ãÍ≤å Ï§ÑÎ∞îÍøà)

            #Ìï¥ÏãúÌÉúÍ∑∏ #Î™®Ïùå
                `;
            userPrompt = `[ÎåÄÎ≥∏ ÎÇ¥Ïö©]\n${script} `;
            maxTokens = 2000;

        } else if (mode === "generate_thumbnail_plan") {
            // ... (No changes here)
            const { script, topic, extraInstruction } = body;
            systemPrompt = `
 You are a YouTube Viral Thumbnail Consultant 'Antigravity'.
 Your goal is to generate 3 high - CTR thumbnail concepts based on the provided script and topic.
 
 ‚úÖ ** Input Data **
                 - Topic: ${topic}
             - Script Summary: ${script.slice(0, 1500)}...
             - Extra Instruction: ${extraInstruction || "None"}
 
 ‚úÖ ** Goal **
                 Generate 3 distinct concepts:
             1.(A) Fact / Number / Conclusion(Ìå©Ìä∏ / Ïà´Ïûê / Í≤∞Î°†Ìòï)
             2.(B) Fear / Threat(Í≥µÌè¨ / ÏúÑÌòëÌòï)
             3.(C) Curiosity / Twist(Ìò∏Í∏∞Ïã¨ / Î∞òÏ†ÑÌòï)
 
 ‚úÖ ** CORE RULES(MUST FOLLOW) **
                 1. ** Text Language **: ** MUST BE KOREAN **. The overlay text (line1, line2) is for a Korean audience.
    - "Stop Learning Coding" (X) -> "ÏΩîÎî© Î∞∞Ïö∞ÏßÄ ÎßàÏÑ∏Ïöî" (O).
    - "Jensen Huang" (X) -> "Ï††Ïä® Ìô©" (O).
 2. ** Text Length **: User demands ** AT LEAST 15 characters ** for the main text.
    - Recommended: 18~26 chars.
    - Ban: Short text like "AI doctor fast"(Trash).
    - Use patterns: "[Shocking Declaration] + [Reason/Result]" or "[Twist Question] + [Implication]".
 3. ** Visuals **:
             - Image Prompt must specify "NO TEXT, NO LETTERS".
    - High contrast, simple background, clear subject.
 4. ** Protagonist **:
             - If a specific person is mentioned (e.g. Jensen Huang), you MUST put their name AND SIGNATURE LOOK ONLY in 'protagonistDescription'.
             - **CRITICAL**: DO NOT describe race, age, or gender for famous people (e.g. DO NOT say "Asian man in 60s"). It confuses the AI.
             - Good Example: "Jensen Huang, wearing black leather jacket, looking confident".
             - Bad Example: "Jensen Huang, Asian male, 60 years old".
 
 ‚úÖ ** Output Format(Strict JSON) **
                 Return EXACTLY this JSON structure:
 
             {
                 "headline": "Core Assertion (1 line, Korean)",
                     "shockFact": "Shocking Fact (1 line, Korean)",
                     "protagonistDescription": "Name + Signature Look (e.g. Jensen Huang, leather jacket). English Only. Empty if none.",
                         "concepts": [
                             {
                                 "id": "A_fact",
                                 "label": "Ìå©Ìä∏/Ï∂©Í≤©",
                                 "overlayText": {
                                     "line1": "Main provocative text (15+ chars, KOREAN)",
                                     "line2": "Sub text (optional, short, KOREAN)"
                                 },
                                 "highlightWords": ["Keyword1(Korean)", "Keyword2(Korean)"],
                                 "protagonistDescription": "Override if this concept needs specific look (optimal)",
                                 "layoutPlan": "Description of layout (e.g. Robot on left, text on right)",
                                 "bgPromptEn": "English DALL-E prompt. NO TEXT. High contrast. 16:9."
                             },
                             {
                                 "id": "B_fear",
                                 "label": "Í≥µÌè¨/ÏúÑÌòë",
                                 "overlayText": { "line1": "...", "line2": "..." },
                                 "highlightWords": ["..."],
                                 "protagonistDescription": "...",
                                 "layoutPlan": "...",
                                 "bgPromptEn": "..."
                             },
                             {
                                 "id": "C_curiosity",
                                 "label": "Ìò∏Í∏∞Ïã¨/Î∞òÏ†Ñ",
                                 "overlayText": { "line1": "...", "line2": "..." },
                                 "highlightWords": ["..."],
                                 "protagonistDescription": "...",
                                 "layoutPlan": "...",
                                 "bgPromptEn": "..."
                             }
                         ]
             }
             `;

            const completion = await client.chat.completions.create({
                model: "gpt-4o",
                messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: `Generate viral thumbnail strategy for: ${topic} ` },
                ],
                response_format: { type: "json_object" },
            });

            const result = completion.choices[0].message.content || "{}";
            return NextResponse.json({ result: JSON.parse(result) });


        } else if (mode === "generate_image") {
            const { prompt, aspectRatio, style } = body;
            if (!prompt) return NextResponse.json({ error: "promptÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§." }, { status: 400 });

            // DALL-E 3 Size Mapping
            // 16:9 -> 1792x1024
            // 9:16 -> 1024x1792
            // Square -> 1024x1024
            let size = "1024x1024";
            if (aspectRatio === "9:16") size = "1024x1792";
            else if (aspectRatio === "16:9") size = "1792x1024";

            const response = await client.images.generate({
                model: "dall-e-3",
                prompt: prompt,
                n: 1,
                size: size as any,
                style: style || "vivid", // 'natural' or 'vivid'
                response_format: "b64_json",
            });

            const b64 = response.data?.[0]?.b64_json;
            return NextResponse.json({ imageUrl: `data:image/png;base64,${b64}` });

        } else {
            // Default: generate topics
            if (!keyword) return NextResponse.json({ error: "keywordÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§." }, { status: 400 });

            const mood = type === 'niche'
                ? "Î∏îÎ£®Ïò§ÏÖò Ï£ºÏ†ú"
                : "Î©îÍ∞Ä Ìä∏ÎûòÌîΩ Ï£ºÏ†ú";

            // üÜï ÌòÑÏû¨ ÎÇ†Ïßú Ï£ºÏûÖ (ÏãúÍ∞Ñ Ïù∏Ïãù Î∂ÄÏó¨)
            const today = new Date().toLocaleDateString('ko-KR', {
                year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'
            });

            // üÜï Ìä∏Î†åÎìú Ïª®ÌÖçÏä§Ìä∏ (YouTube Ïù∏Í∏∞ ÎèôÏòÅÏÉÅ Ï†úÎ™©)
            const trendContext = body.trendContext || "";

            // üÜï Îß§Î≤à Îã§Î•∏ Í¥ÄÏ†ê Î∂ÄÏó¨ (ÎûúÎç§ÏÑ± Ï¶ùÍ∞Ä)
            const perspectives = [
                'Í≤ΩÏ†úÏ†Å ÌååÍ∏âÌö®Í≥º Ï§ëÏã¨',
                'Ïà®Í≤®ÏßÑ Îí∑Ïù¥ÏïºÍ∏∞ Ï§ëÏã¨',
                'ÎÖºÏüÅÍ≥º Î∞òÎ°† Ï§ëÏã¨',
                'ÎØ∏Îûò ÏòàÏ∏° Ï§ëÏã¨',
                'Í∞úÏù∏Ïùò ÏÇ∂Ïóê ÎØ∏ÏπòÎäî ÏòÅÌñ• Ï§ëÏã¨',
                'Ï∂©Í≤©Ï†ÅÏù∏ ÌÜµÍ≥Ñ/Ïà´Ïûê Ï§ëÏã¨',
                'Ïú†Î™ÖÏù∏/Í∏∞ÏóÖÏùò ÎπÑÌïòÏù∏Îìú Ï§ëÏã¨',
                'ÏùåÎ™®Î°†/ÎØ∏Ïä§ÌÑ∞Î¶¨ Ï§ëÏã¨'
            ];
            const randomPerspective = perspectives[Math.floor(Math.random() * perspectives.length)];

            // üÜï Ï∂îÍ∞Ä ÎûúÎç§ ÌÇ§ÏõåÎìú (Îã§ÏñëÏÑ± Í∞ïÌôî)
            const extraAngles = ['Î∞òÏ†Ñ', 'Ìè≠Î°ú', 'ÎπÑÎ∞Ä', 'ÏßÑÏã§', 'Ïã§Ï≤¥', 'ÏúÑÌóò', 'Í≤ΩÍ≥†', 'Ï∂©Í≤©'];
            const randomAngle = extraAngles[Math.floor(Math.random() * extraAngles.length)];

            systemPrompt = `
            ÎÑàÎäî Ïú†ÌäúÎ∏å Ï±ÑÎÑêÏùò 'Ï£ºÏ†ú ÏÑ†Ï†ï' Îã¥ÎãπÏûêÎã§.
            üìÖ Ïò§Îäò ÎÇ†Ïßú: ${today}
            
            ÏÇ¨Ïö©ÏûêÍ∞Ä ÏÑ†ÌÉùÌïú Ïπ¥ÌÖåÍ≥†Î¶¨ '${keyword}'Ïóê ÎßûÏ∂∞, "ÏßÄÍ∏à Ï°∞ÌöåÏàò ÎÇòÏò¨ ÌôïÎ•† ÎÜíÏùÄ Íµ¨Ï≤¥Ï†ÅÏù∏ ÏÜåÏ£ºÏ†ú" 10Í∞úÎ•º ÎΩëÏïÑÎùº.

            ${trendContext ? `
            [üî• ÌòÑÏû¨ Ïú†ÌäúÎ∏å Ïù∏Í∏∞ ÎèôÏòÅÏÉÅ - Ïù¥ÏôÄ Ïó∞Í¥ÄÎêòÍ±∞ÎÇò ÎåÄÏùëÌïòÎäî Ï£ºÏ†ú Ïö∞ÏÑ† Í≥†Î†§]
            ${trendContext}
            ` : ''}

            [üéØ Ïù¥Î≤à ÏöîÏ≤≠Ïùò ÌäπÎ≥Ñ Í¥ÄÏ†ê: ${randomPerspective}]
            [üí° ÌÇ§ÏõåÎìú ÌûåÌä∏: ${randomAngle}]

            [ÌïÑÏàò ÏöîÏ≤≠ÏÇ¨Ìï≠]
            1. Ï∂îÏÉÅÏ†ÅÏù∏ Îã®Ïñ¥ Í∏àÏßÄ(Ïòà: AIÏùò ÎØ∏Îûò X -> Ï††Ïä®Ìô©Ïùò 2026 ÏòàÏñ∏ O)
            2. Íµ¨Ï≤¥Ï†ÅÏù∏ Ïù∏Î¨º, Í∏∞ÏóÖ, ÏÇ¨Í±¥, Ï†úÌíàÎ™ÖÏùÑ Ìè¨Ìï®Ìï† Í≤É.
            3. 10Í∞úÍ∞Ä ÏÑúÎ°ú Í≤πÏπòÏßÄ ÏïäÍ≤å Îã§ÏñëÌïú Í∞ÅÎèÑ(Í≤ΩÏ†ú, ÏÇ¨Ìöå, Í∏∞Ïà†, Ïù¥Ïäà)ÏóêÏÑú ÎΩëÏùÑ Í≤É.
            4. ÎÑàÎ¨¥ ÎªîÌïú Ï£ºÏ†úÎ≥¥Îã§Îäî "${randomAngle}"Ïù¥ Îì§Ïñ¥Í∞Ñ ÏûêÍ∑πÏ†ÅÏù∏ ÌÇ§ÏõåÎìú ÏúÑÏ£º.
            5. Ïò§Îäò ÎÇ†Ïßú Í∏∞Ï§Ä ÏµúÏã† Ïù¥ÏäàÎ•º Î∞òÏòÅÌï† Í≤É.

                ${condensedGuide}
            [Ï∂úÎ†• Ìè¨Îß∑]
            1.[Íµ¨Ï≤¥Ï†Å ÌÇ§ÏõåÎìú]-[ÌïµÏã¨ ÌõÑÌÇπ Ìè¨Ïù∏Ìä∏]
            2.[Íµ¨Ï≤¥Ï†Å ÌÇ§ÏõåÎìú]-[ÌïµÏã¨ ÌõÑÌÇπ Ìè¨Ïù∏Ìä∏]
            ...
            `;
            userPrompt = `Ïπ¥ÌÖåÍ≥†Î¶¨: ${keyword} `;
        }

        const completion = await client.chat.completions.create({
            model: "gpt-4o",
            messages: [
                { role: "system", content: systemPrompt },
                { role: "user", content: userPrompt }
            ],
            temperature: 0.95, // üÜï Ï∞ΩÏùòÏÑ± Ï¶ùÍ∞Ä (0.8 -> 0.95)
            max_tokens: maxTokens, // Enforce limit
        });

        const result = completion.choices[0]?.message?.content || "";
        return NextResponse.json({ result });
    } catch (err: any) {
        console.error("‚ùå OpenAI API Route Error:", err);
        return NextResponse.json(
            { error: err?.message ?? "Unknown error" },
            { status: 500 }
        );
    }
}